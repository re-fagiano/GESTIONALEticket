{% extends "base.html" %}
{% block title %}Sincronizzazione Google Calendar{% endblock %}
{% block content %}
<h2>Sincronizzazione clienti da Google Calendar</h2>
<p>
    Da questa sezione puoi monitorare lo stato della connessione con Google Calendar
    e, se hai i permessi di amministratore, avviare manualmente la sincronizzazione
    dei clienti partendo dagli eventi salvati nel calendario configurato.
</p>

<section class="info">
    <strong>Stato configurazione</strong>
    <ul>
        <li>File credenziali: {{ status.credentials_path }} {% if status.credentials_exists %}✅{% else %}❌{% endif %}</li>
        <li>Token salvato: {{ status.token_path }} {% if status.token_exists %}✅{% else %}❌{% endif %}</li>
        <li>Token valido: {% if status.token_valid %}sì{% else %}no{% endif %}{% if status.token_has_refresh %} (refresh disponibile){% endif %}</li>
        <li>Scopi OAuth: {{ status.scopes | join(', ') }}</li>
        {% if status.token_expiry %}
            <li>Scadenza token: {{ status.token_expiry }}</li>
        {% endif %}
    </ul>
    {% if not status.credentials_exists %}
        <p>
            Carica il file JSON scaricato da Google Cloud incollandolo nel modulo
            <em>JSON credenziali OAuth</em> qui sotto: verrà salvato in
            <code>{{ status.credentials_path }}</code> e riutilizzato automaticamente.
        </p>
    {% elif not status.token_exists %}
        <p>
            Non è stato trovato un token salvato. Se hai già completato il flusso OAuth
            altrove, incolla il JSON nel modulo <em>JSON token salvato</em> qui sotto.
            In alternativa esegui il comando
            <code>python -m jobs.sync_calendar_customers --local-server</code> per
            generare un nuovo token e poi incollane il contenuto.
        </p>
    {% endif %}
</section>

{% if can_manage_calendar %}
<section class="info" style="margin-top: 1.5rem;">
    <strong>Carica configurazione OAuth senza console</strong>
    <p>
        Se non puoi accedere alla console del server incolla qui sotto il contenuto dei file
        JSON generati da Google Cloud. Verranno salvati automaticamente nelle posizioni
        configurate e saranno riutilizzati per le sincronizzazioni future.
    </p>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1rem;">
        <form method="post">
            <input type="hidden" name="action" value="save_credentials" />
            <label for="credentials_json">JSON credenziali OAuth</label>
            <textarea id="credentials_json" name="credentials_json" rows="8" placeholder="{ &quot;installed&quot;: { ... } }"></textarea>
            <button type="submit">Salva credenziali</button>
        </form>
        <form method="post">
            <input type="hidden" name="action" value="save_token" />
            <label for="token_json">JSON token salvato</label>
            <textarea id="token_json" name="token_json" rows="8" placeholder="{ &quot;token&quot;: &quot;ya29...&quot; }"></textarea>
            <button type="submit">Salva token</button>
        </form>
    </div>
</section>

<form method="post" class="calendar-sync-form" style="margin-top: 1.5rem;">
    <input type="hidden" name="action" value="run_sync" />
    <label for="calendar_id">ID calendario Google</label>
    <input type="text" id="calendar_id" name="calendar_id" value="{{ form_values.calendar_id }}" placeholder="primary" />

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem;">
        <div>
            <label for="past_days">Giorni da analizzare nel passato</label>
            <input type="number" id="past_days" name="past_days" min="0" value="{{ form_values.past_days }}" />
        </div>
        <div>
            <label for="future_days">Giorni da analizzare nel futuro</label>
            <input type="number" id="future_days" name="future_days" min="0" value="{{ form_values.future_days }}" />
        </div>
        <div>
            <label for="max_results">Numero massimo di eventi</label>
            <input type="number" id="max_results" name="max_results" min="1" value="{{ form_values.max_results }}" />
        </div>
    </div>

    <button type="submit"{% if not status.credentials_exists or not status.token_exists %} disabled{% endif %}>
        Avvia sincronizzazione
    </button>
</form>
{% else %}
<section class="info" style="margin-top: 1.5rem;">
    <strong>Accesso limitato</strong>
    <p>
        Solo gli amministratori possono lanciare la sincronizzazione manuale con Google Calendar.
        Se hai bisogno di questa funzionalità richiedi l'abilitazione a un amministratore.
    </p>
</section>
{% endif %}

{% if stats %}
    <section class="info" style="margin-top: 1.5rem;">
        <strong>Risultato sincronizzazione</strong>
        <ul>
            <li>Calendario interrogato: {{ sync_details.calendar_id }}</li>
            <li>Eventi letti: {{ sync_details.events_count }}</li>
            <li>Clienti rilevati: {{ sync_details.candidates_count }}</li>
            <li>Creati: {{ stats.created }} | Aggiornati: {{ stats.updated }} | Invariati: {{ stats.skipped }}</li>
        </ul>
        <p>
            Intervallo analizzato: ultimi {{ sync_details.past_days }} giorni e prossimi
            {{ sync_details.future_days }} giorni (max {{ sync_details.max_results }} eventi).
        </p>
    </section>
{% endif %}
{% endblock %}
