{% extends 'base.html' %}
{% block title %}Riparazioni{% endblock %}
{% block content %}
{% set repair_status_labels = repair_status_labels or {} %}
{% set current_filters = current_filters or {} %}
{% set selected_status = current_filters.get('status') %}
{% set from_date = current_filters.get('from_date') %}
{% set to_date = current_filters.get('to_date') %}
<h2>Riparazioni</h2>
<div class="status-legend">
    {% for status_value, status_label in repair_statuses %}
        {% set status_slug = status_value|replace('_', '-') %}
        <span class="badge badge-{{ status_slug }}">{{ status_label }}</span>
    {% endfor %}
</div>
<form method="get" action="{{ url_for('repairs') }}" class="filters-form">
    <div class="form-group">
        <label for="status">Stato</label>
        <select id="status" name="status">
            <option value="">Tutti gli stati</option>
            {% for status_value, status_label in repair_statuses %}
                <option value="{{ status_value }}"{% if status_value == selected_status %} selected{% endif %}>{{ status_label }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group">
        <label for="from_date">Da data</label>
        <input type="date" id="from_date" name="from_date" value="{{ from_date }}">
    </div>
    <div class="form-group">
        <label for="to_date">A data</label>
        <input type="date" id="to_date" name="to_date" value="{{ to_date }}">
    </div>
    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Applica filtri</button>
        <a href="{{ url_for('repairs') }}" class="btn btn-secondary">Azzera</a>
    </div>
</form>
{% if repairs %}
<table>
    <thead>
    <tr>
        <th>Ticket</th>
        <th>Cliente</th>
        <th>Prodotto</th>
        <th>Descrizione problema</th>
        <th>Pagamento</th>
        <th>Stato</th>
        <th>Ricevuto</th>
        <th>Riparato</th>
        <th>Consegnato</th>
        {% if current_user.is_authenticated and current_user.is_admin %}
        <th class="actions-column">Azioni</th>
        {% endif %}
    </tr>
    </thead>
    <tbody>
    {% for repair in repairs %}
    <tr>
        <td><a href="{{ url_for('ticket_detail', ticket_id=repair['id']) }}">{{ '%04d'|format(repair['id']) }} - {{ repair['subject'] }}</a></td>
        <td>{{ repair['customer_name'] }}</td>
        <td>{{ repair['product'] or '-' }}</td>
        <td>{{ repair['issue_description'] or '-' }}</td>
        <td>{{ repair['payment_info'] or '-' }}</td>
        {% set repair_status_slug = (repair['repair_status'] or '')|lower|replace(' ', '-')|replace('_', '-') %}
        <td>
            {% set status_label = repair_status_labels.get(repair['repair_status'], repair['repair_status'] or 'N/A') %}
            <span class="badge badge-{{ repair_status_slug if repair_status_slug else 'pending' }}">{{ status_label }}</span>
        </td>
        <td>{{ repair['date_received'] or '-' }}</td>
        <td>{{ repair['date_repaired'] or '-' }}</td>
        <td>{{ repair['date_returned'] or '-' }}</td>
        {% if current_user.is_authenticated and current_user.is_admin %}
        <td class="actions-column">
            <form method="post"
                  action="{{ url_for('delete_repair', ticket_id=repair['id']) }}"
                  class="inline-form"
                  onsubmit="return confirm('Confermi l\'eliminazione della riparazione? Il ticket verrÃ  rimosso definitivamente.');">
                {% if csrf_token is defined %}
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                {% endif %}
                {% if current_filters %}
                    {% for filter_key, filter_value in current_filters.items() if filter_value %}
                    <input type="hidden" name="filter_{{ filter_key }}" value="{{ filter_value }}">
                    {% endfor %}
                {% endif %}
                <button type="submit" class="btn-danger">Elimina</button>
            </form>
        </td>
        {% endif %}
    </tr>
    {% endfor %}
    </tbody>
</table>
{% else %}
<p>Nessuna riparazione registrata.</p>
{% endif %}
{% endblock %}
