{% extends 'base.html' %}
{% set ticket_number = '%04d'|format(ticket['id']) %}
{% block title %}Ticket #{{ ticket_number }}{% endblock %}
{% block content %}
{% set can_edit = current_user.is_authenticated and current_user.is_admin %}
<div class="ticket-header">
    <h2>Ticket #{{ ticket_number }}</h2>
    <div class="ticket-header-details">
        <div><strong>Cliente:</strong> {{ ticket['customer_name'] }}</div>
        <div>
            <strong>Stato:</strong>
            {% set status_slug = ticket['status']|replace('_', '-') %}
            <span class="badge badge-{{ status_slug }}">{{ ticket_status_labels.get(ticket['status'], ticket['status']) }}</span>
        </div>
    </div>
</div>
<ul>
    <li><strong>Oggetto:</strong> {{ ticket['subject'] }}</li>
    <li><strong>Descrizione:</strong> {{ ticket['description'] or 'N/A' }}</li>
    <li><strong>Pagamento:</strong> {{ ticket['payment_info'] or 'N/A' }}</li>
    <li><strong>Creato il:</strong> {{ ticket['created_at'] }}</li>
    <li><strong>Creato da:</strong> {{ ticket['created_by_username'] or 'N/D' }}</li>
    <li>
        <strong>Ultima modifica:</strong>
        {{ ticket['updated_at'] }}
        {% if ticket['last_modified_by_username'] %}
        ({{ ticket['last_modified_by_username'] }})
        {% endif %}
    </li>
</ul>
<form method="post" class="ticket-edit-form">
    <label for="status">Stato ticket</label>
    <select id="status" name="status" {% if not can_edit %}disabled{% endif %}>
        {% for value, label in ticket_statuses %}
        <option value="{{ value }}" {% if ticket['status'] == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>

    <h3>Dati riparazione</h3>
    <label for="product">Prodotto</label>
    <input type="text" id="product" name="product" value="{{ ticket['product'] or '' }}" {% if not can_edit %}readonly{% endif %}>

    <label for="issue_description">Descrizione problema</label>
    <textarea id="issue_description" name="issue_description" rows="4" {% if not can_edit %}readonly{% endif %}>{{ ticket['issue_description'] or '' }}</textarea>

    <label for="payment_info">Informazioni pagamento</label>
    <textarea id="payment_info" name="payment_info" rows="3" {% if not can_edit %}readonly{% endif %}>{{ ticket['payment_info'] or '' }}</textarea>

    <label for="repair_status">Stato riparazione</label>
    <select id="repair_status" name="repair_status" {% if not can_edit %}disabled{% endif %}>
        {% for value, label in repair_statuses %}
        <option value="{{ value }}" {% if ticket['repair_status'] == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>

    <label for="date_received">Data ricezione</label>
    <input type="date" id="date_received" name="date_received" value="{{ ticket['date_received'] or '' }}" {% if not can_edit %}readonly{% endif %}>

    <label for="date_repaired">Data riparazione</label>
    <input type="date" id="date_repaired" name="date_repaired" value="{{ ticket['date_repaired'] or '' }}" {% if not can_edit %}readonly{% endif %}>

    <label for="date_returned">Data consegna</label>
    <input type="date" id="date_returned" name="date_returned" value="{{ ticket['date_returned'] or '' }}" {% if not can_edit %}readonly{% endif %}>

    {% if can_edit %}
    <button type="submit">Salva modifiche</button>
    {% else %}
    <p class="info">Solo un amministratore può modificare lo stato del ticket e i dati di riparazione.</p>
    {% endif %}
</form>

<section class="ticket-history">
    <h3>Storico modifiche</h3>
    {% if history_entries %}
    <div class="table-responsive">
        <table class="history-table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Utente</th>
                    <th>Campo</th>
                    <th>Da</th>
                    <th>A</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in history_entries %}
                <tr>
                    <td>{{ entry['changed_at'] }}</td>
                    <td>{{ entry['changed_by_username'] or 'N/D' }}</td>
                    <td>{{ ticket_history_field_labels.get(entry['field'], entry['field']) }}</td>
                    <td>{{ entry['old_value'] if entry['old_value'] is not none else '—' }}</td>
                    <td>{{ entry['new_value'] if entry['new_value'] is not none else '—' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="info">Nessuna modifica registrata per questo ticket.</p>
    {% endif %}
</section>
{% endblock %}
