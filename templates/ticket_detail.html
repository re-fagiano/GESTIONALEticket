{% extends 'base.html' %}
{% set ticket_number = '%04d'|format(ticket['id']) %}
{% block title %}Ticket #{{ ticket_number }}{% endblock %}
{% block content %}
{% set can_edit = current_user.is_authenticated and current_user.is_admin %}
<div class="ticket-header">
    <h2>Ticket #{{ ticket_number }}</h2>
    <div class="ticket-header-details">
        <div><strong>Cliente:</strong> {{ ticket['customer_name'] }}</div>
        <div>
            <strong>Stato:</strong>
            {% set status_slug = ticket['status']|replace('_', '-') %}
            <span class="badge badge-{{ status_slug }}">{{ ticket_status_labels.get(ticket['status'], ticket['status']) }}</span>
        </div>
    </div>
</div>
<ul>
    <li><strong>Oggetto:</strong> {{ ticket['subject'] }}</li>
    <li><strong>Descrizione:</strong> {{ ticket['description'] or 'N/A' }}</li>
    <li><strong>Creato il:</strong> {{ ticket['created_at'] }}</li>
    <li><strong>Aggiornato il:</strong> {{ ticket['updated_at'] }}</li>
</ul>
<form method="post" class="ticket-edit-form">
    <label for="status">Stato ticket</label>
    <select id="status" name="status" {% if not can_edit %}disabled{% endif %}>
        {% for value, label in ticket_statuses %}
        <option value="{{ value }}" {% if ticket['status'] == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>

    <h3>Dati riparazione</h3>
    <label for="product">Prodotto</label>
    <input type="text" id="product" name="product" value="{{ ticket['product'] or '' }}" {% if not can_edit %}readonly{% endif %}>

    <label for="issue_description">Descrizione problema</label>
    <textarea id="issue_description" name="issue_description" rows="4" {% if not can_edit %}readonly{% endif %}>{{ ticket['issue_description'] or '' }}</textarea>

    <label for="repair_status">Stato riparazione</label>
    <select id="repair_status" name="repair_status" {% if not can_edit %}disabled{% endif %}>
        {% for value, label in repair_statuses %}
        <option value="{{ value }}" {% if ticket['repair_status'] == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>

    <label for="date_received">Data ricezione</label>
    <input type="date" id="date_received" name="date_received" value="{{ ticket['date_received'] or '' }}" {% if not can_edit %}readonly{% endif %}>

    <label for="date_repaired">Data riparazione</label>
    <input type="date" id="date_repaired" name="date_repaired" value="{{ ticket['date_repaired'] or '' }}" {% if not can_edit %}readonly{% endif %}>

    <label for="date_returned">Data consegna</label>
    <input type="date" id="date_returned" name="date_returned" value="{{ ticket['date_returned'] or '' }}" {% if not can_edit %}readonly{% endif %}>

    {% if can_edit %}
    <button type="submit">Salva modifiche</button>
    {% else %}
    <p class="info">Solo un amministratore pu√≤ modificare lo stato del ticket e i dati di riparazione.</p>
    {% endif %}
</form>
{% endblock %}
