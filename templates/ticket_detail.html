{% extends 'base.html' %}
{% set ticket_number = '%04d'|format(ticket['id']) %}
{% block title %}Ticket #{{ ticket_number }}{% endblock %}
{% block content %}
{% set can_edit = current_user.is_authenticated %}
<div class="ticket-header">
    <h2>Ticket #{{ ticket_number }}</h2>
    <div class="ticket-header-details">
        <div><strong>Cliente:</strong> {{ ticket['customer_name'] }}</div>
        <div>
            <strong>Stato:</strong>
            {% set status_slug = ticket['status']|replace('_', '-') %}
            <span class="badge badge-{{ status_slug }}">{{ ticket_status_labels.get(ticket['status'], ticket['status']) }}</span>
        </div>
    </div>
</div>
<ul>
    <li><strong>Oggetto:</strong> {{ ticket['subject'] }}</li>
    <li><strong>Descrizione:</strong> {{ ticket['description'] or 'N/A' }}</li>
    <li><strong>Pagamento:</strong> {{ ticket['payment_info'] or 'N/A' }}</li>
    <li><strong>Creato il:</strong> {{ ticket['created_at'] }}</li>
    <li><strong>Creato da:</strong> {{ ticket['created_by_username'] or 'N/D' }}</li>
    <li>
        <strong>Ultima modifica:</strong>
        {{ ticket['updated_at'] }}
        {% if ticket['last_modified_by_username'] %}
        ({{ ticket['last_modified_by_username'] }})
        {% endif %}
    </li>
</ul>
<form method="post" class="ticket-edit-form">
    <input type="hidden" name="form_name" value="details">
    <label for="status">Stato ticket</label>
    <select id="status" name="status" {% if not can_edit %}disabled{% endif %}>
        {% for value, label in ticket_statuses %}
        <option value="{{ value }}" {% if ticket['status'] == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>

    <h3>Dati riparazione</h3>
    <label for="product">Prodotto</label>
    <input type="text" id="product" name="product" value="{{ ticket['product'] or '' }}" {% if not can_edit %}readonly{% endif %}>

    <div class="ai-helper">
        <label for="issue_description">Descrizione problema</label>
        <textarea id="issue_description" name="issue_description" rows="4" {% if not can_edit %}readonly{% endif %}>{{ ticket['issue_description'] or '' }}</textarea>
        <button type="button" class="ai-suggest-button" data-target="issue_description" {% if not can_edit %}disabled{% endif %}>
            Chiedi all’AI
        </button>
        <div class="ai-suggestion" aria-live="polite"></div>
    </div>

    <label for="payment_info">Informazioni pagamento</label>
    <textarea id="payment_info" name="payment_info" rows="3" {% if not can_edit %}readonly{% endif %}>{{ ticket['payment_info'] or '' }}</textarea>

    <label for="repair_status">Stato riparazione</label>
    <select id="repair_status" name="repair_status" {% if not can_edit %}disabled{% endif %}>
        {% for value, label in repair_statuses %}
        <option value="{{ value }}" {% if ticket['repair_status'] == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>

    <label for="date_received">Data ricezione</label>
    <input type="date" id="date_received" name="date_received" value="{{ ticket['date_received'] or '' }}" {% if not can_edit %}readonly{% endif %}>

    <label for="date_repaired">Data riparazione</label>
    <input type="date" id="date_repaired" name="date_repaired" value="{{ ticket['date_repaired'] or '' }}" {% if not can_edit %}readonly{% endif %}>

    <label for="date_returned">Data consegna</label>
    <input type="date" id="date_returned" name="date_returned" value="{{ ticket['date_returned'] or '' }}" {% if not can_edit %}readonly{% endif %}>

    <button type="submit" {% if not can_edit %}disabled{% endif %}>Salva modifiche</button>
</form>

<section class="ticket-attachments">
    <h3>Allegati</h3>
    {% if attachments %}
    <ul class="attachments-list">
        {% for attachment in attachments %}
        <li>
            <div class="attachment-info">
                <strong>{{ attachment['original_filename'] }}</strong>
                <span class="attachment-meta">
                    {% if attachment['file_size'] %}
                    ({{ (attachment['file_size'] / 1024)|round(1) }} KB)
                    {% endif %}
                    {% if attachment['uploaded_at'] %}
                    &middot; {{ attachment['uploaded_at'] }}
                    {% endif %}
                    {% if attachment['uploaded_by_username'] %}
                    &middot; {{ attachment['uploaded_by_username'] }}
                    {% endif %}
                </span>
            </div>
            <a class="attachment-download" href="{{ url_for('download_ticket_attachment', ticket_id=ticket['id'], attachment_id=attachment['id']) }}">Scarica</a>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="info">Nessun allegato presente per questo ticket.</p>
    {% endif %}
    <form method="post" enctype="multipart/form-data" class="attachment-upload-form">
        <input type="hidden" name="form_name" value="attachments">
        <label for="attachment_files">Aggiungi allegati</label>
        <input type="file" id="attachment_files" name="attachments" multiple {% if not can_edit %}disabled{% endif %}>
        <button type="submit" {% if not can_edit %}disabled{% endif %}>Carica allegati</button>
    </form>
</section>

<section class="ticket-history">
    <h3>Storico modifiche</h3>
    {% if history_entries %}
    <div class="table-responsive">
        <table class="history-table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Utente</th>
                    <th>Campo</th>
                    <th>Da</th>
                    <th>A</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in history_entries %}
                <tr>
                    <td>{{ entry['changed_at'] }}</td>
                    <td>{{ entry['changed_by_username'] or 'N/D' }}</td>
                    <td>{{ ticket_history_field_labels.get(entry['field'], entry['field']) }}</td>
                    <td>{{ entry['old_value'] if entry['old_value'] is not none else '—' }}</td>
                    <td>{{ entry['new_value'] if entry['new_value'] is not none else '—' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="info">Nessuna modifica registrata per questo ticket.</p>
    {% endif %}
</section>
{% endblock %}
