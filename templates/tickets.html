{% extends 'base.html' %}
{% block title %}Ticket{% endblock %}
{% block content %}
<h2>Ticket</h2>
<form method="get" action="{{ url_for('tickets') }}" class="filters">
    <label for="status">Stato:</label>
    <select name="status" id="status" onchange="this.form.submit()">
        <option value="" {% if not selected_status %}selected{% endif %}>Tutti</option>
        {% for value, label in statuses %}
        <option value="{{ value }}" {% if value == selected_status %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>
    <noscript><button type="submit">Filtra</button></noscript>
</form>
<p><a class="button" href="{{ url_for('add_ticket', **current_filters) }}">Nuovo ticket</a></p>
{% if tickets %}
<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>Cliente / Stato</th>
        <th>Oggetto</th>
        <th>Creato il</th>
        {% if current_user.is_authenticated and current_user.is_admin %}
        <th class="actions-column">Azioni</th>
        {% endif %}
    </tr>
    </thead>
    <tbody>
    {% for ticket in tickets %}
    <tr>
        <td><a href="{{ url_for('ticket_detail', ticket_id=ticket['id']) }}">{{ '%04d'|format(ticket['id']) }}</a></td>
        <td>
            <div class="ticket-customer">{{ ticket['customer_name'] }}</div>
            {% set status_slug = ticket['status']|replace('_', '-') %}
            <div class="ticket-status">
                <span class="badge badge-{{ status_slug }}">{{ ticket_status_labels.get(ticket['status'], ticket['status']) }}</span>
            </div>
            {% set status_change = (latest_history_entries.get('status') or {}).get(ticket['id']) %}
            <div class="status-meta">
                {% if status_change %}
                <small>Aggiornato il {{ status_change['changed_at'] }}{% if status_change['changed_by_username'] %} da {{ status_change['changed_by_username'] }}{% endif %}</small>
                {% else %}
                <small>Creato il {{ ticket['created_at'] }}{% if ticket['created_by_username'] %} da {{ ticket['created_by_username'] }}{% endif %}</small>
                {% endif %}
            </div>
        </td>
        <td>{{ ticket['subject'] }}</td>
        <td>{{ ticket['created_at'] }}</td>
        {% if current_user.is_authenticated and current_user.is_admin %}
        <td class="actions-column">
            <form method="post"
                  action="{{ url_for('delete_ticket', ticket_id=ticket['id']) }}"
                  class="inline-form"
                  onsubmit="return confirm('Confermi l\'eliminazione del ticket selezionato?');">
                {% if csrf_token is defined %}
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                {% endif %}
                {% if current_filters %}
                    {% for filter_key, filter_value in current_filters.items() if filter_value %}
                    <input type="hidden" name="filter_{{ filter_key }}" value="{{ filter_value }}">
                    {% endfor %}
                {% endif %}
                <button type="submit" class="btn-danger">Elimina</button>
            </form>
        </td>
        {% endif %}
    </tr>
    {% endfor %}
    </tbody>
</table>
{% else %}
<p>Nessun ticket presente.</p>
{% endif %}
{% endblock %}
