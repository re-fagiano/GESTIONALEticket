{% extends 'base.html' %}
{% block title %}Nuovo ticket{% endblock %}
{% block content %}
<h2>Crea ticket</h2>
<form method="post" enctype="multipart/form-data">
    <label for="customer_search">Cliente *</label>
    <input type="hidden" id="customer_id" data-name="customer_id" value="{{ request.form.get('customer_id', '') }}">
    <input type="text"
           id="customer_search"
           name="customer_search"
           list="customer_list"
           placeholder="Inizia a digitare per cercare un cliente"
           autocomplete="off"
           required
           value="{{ request.form.get('customer_search', '') }}">
    <datalist id="customer_list">
        {% for customer in customers %}
        <option value="{{ customer['name'] }}" data-id="{{ customer['id'] }}"></option>
        {% endfor %}
    </datalist>
    <noscript>
        <select id="customer_id_noscript" name="customer_id" required>
            <option value="">-- seleziona --</option>
            {% for customer in customers %}
            <option value="{{ customer['id'] }}">{{ customer['name'] }}</option>
            {% endfor %}
        </select>
    </noscript>

    <label for="subject">Oggetto *</label>
    <input type="text" id="subject" name="subject" required>

    <label for="description">Descrizione</label>
    <textarea id="description" name="description" rows="4"></textarea>

    <label for="ticket_status">Stato ticket *</label>
    <select id="ticket_status" name="ticket_status" required>
        {% set default_ticket_status = ticket_statuses[0][0] %}
        {% for value, label in ticket_statuses %}
        <option value="{{ value }}" {% if request.form.get('ticket_status', default_ticket_status) == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>

    <h3>Dati riparazione</h3>
    <p class="info">Compila le informazioni se già disponibili; potrai aggiornarle successivamente dal dettaglio ticket.</p>

    <label for="product">Prodotto</label>
    <input type="text" id="product" name="product" value="{{ request.form.get('product', '') }}">

    <div class="ai-helper">
        <label for="issue_description">Descrizione problema</label>
        <textarea id="issue_description" name="issue_description" rows="4">{{ request.form.get('issue_description', '') }}</textarea>
        <button type="button" class="ai-suggest-button" data-target="issue_description">
            Chiedi all’AI
        </button>
        <div class="ai-suggestion" aria-live="polite"></div>
    </div>

    <label for="payment_info">Informazioni pagamento</label>
    <textarea id="payment_info" name="payment_info" rows="3" placeholder="Es. acconto, metodo di pagamento, note">{{ request.form.get('payment_info', '') }}</textarea>

    <label for="repair_status">Stato riparazione</label>
    <select id="repair_status" name="repair_status">
        {% for value, label in repair_statuses %}
        <option value="{{ value }}" {% if request.form.get('repair_status', repair_statuses[0][0]) == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>

    <label for="date_received">Data ricezione</label>
    <input type="date" id="date_received" name="date_received" value="{{ request.form.get('date_received', '') }}">

    <label for="date_repaired">Data riparazione</label>
    <input type="date" id="date_repaired" name="date_repaired" value="{{ request.form.get('date_repaired', '') }}">

    <label for="date_returned">Data consegna</label>
    <input type="date" id="date_returned" name="date_returned" value="{{ request.form.get('date_returned', '') }}">

    <h3>Allegati</h3>
    <p class="info">Puoi allegare immagini o documenti utili al ticket (dimensione massima 16&nbsp;MB per invio).</p>
    <label for="attachments">Seleziona file</label>
    <input type="file" id="attachments" name="attachments" multiple>

    <button type="submit">Salva</button>
</form>
<script>
    (function() {
        const searchInput = document.getElementById('customer_search');
        const hiddenInput = document.getElementById('customer_id');
        const datalist = document.getElementById('customer_list');
        if (!searchInput || !hiddenInput || !datalist) {
            return;
        }

        hiddenInput.name = hiddenInput.dataset.name || 'customer_id';

        const options = Array.from(datalist.options);

        function findOptionByValue(value) {
            const normalized = value.trim().toLowerCase();
            if (!normalized) {
                return null;
            }
            return options.find((option) => option.value.trim().toLowerCase() === normalized) || null;
        }

        function updateHiddenFromSearch() {
            const match = findOptionByValue(searchInput.value);
            if (match) {
                hiddenInput.value = match.dataset.id || '';
                searchInput.setCustomValidity('');
            } else {
                hiddenInput.value = '';
                if (searchInput.value.trim()) {
                    searchInput.setCustomValidity('Seleziona un cliente dall\'elenco.');
                } else {
                    searchInput.setCustomValidity('Questo campo è obbligatorio.');
                }
            }
        }

        searchInput.addEventListener('change', updateHiddenFromSearch);
        searchInput.addEventListener('input', () => {
            hiddenInput.value = '';
            searchInput.setCustomValidity('');
        });

        const form = searchInput.form;
        if (form) {
            form.addEventListener('submit', (event) => {
                updateHiddenFromSearch();
                if (!hiddenInput.value) {
                    event.preventDefault();
                    searchInput.reportValidity();
                }
            });
        }

        if (hiddenInput.value) {
            const current = options.find((option) => option.dataset.id === hiddenInput.value);
            if (current) {
                searchInput.value = current.value;
            }
        }
    })();
</script>
{% endblock %}
