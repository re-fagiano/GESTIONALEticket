{% extends 'base.html' %}
{% block title %}Nuovo ticket{% endblock %}
{% block content %}
<h2>Crea ticket</h2>
<form method="post" enctype="multipart/form-data">
    <label for="customer_id">Cliente *</label>
    <select id="customer_id" name="customer_id" required>
        <option value="">-- seleziona --</option>
        {% for customer in customers %}
        <option value="{{ customer['id'] }}">{{ customer['code']|upper }} - {{ customer['name'] }}</option>
        {% endfor %}
    </select>

    <label for="subject">Oggetto *</label>
    <input type="text" id="subject" name="subject" required>

    <label for="description">Descrizione</label>
    <textarea id="description" name="description" rows="4"></textarea>

    <label for="ticket_status">Stato ticket *</label>
    <select id="ticket_status" name="ticket_status" required>
        {% set default_ticket_status = ticket_statuses[0][0] %}
        {% for value, label in ticket_statuses %}
        <option value="{{ value }}" {% if request.form.get('ticket_status', default_ticket_status) == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>

    <h3>Dati riparazione</h3>
    <p class="info">Compila le informazioni se già disponibili; potrai aggiornarle successivamente dal dettaglio ticket.</p>

    <label for="product">Prodotto</label>
    <input type="text" id="product" name="product" value="{{ request.form.get('product', '') }}">

    <div class="ai-helper">
        <label for="issue_description">Descrizione problema</label>
        <textarea id="issue_description" name="issue_description" rows="4">{{ request.form.get('issue_description', '') }}</textarea>
        <button type="button" class="ai-suggest-button" data-target="issue_description">
            Chiedi all’AI
        </button>
        <div class="ai-suggestion" aria-live="polite"></div>
    </div>

    <label for="payment_info">Informazioni pagamento</label>
    <textarea id="payment_info" name="payment_info" rows="3" placeholder="Es. acconto, metodo di pagamento, note">{{ request.form.get('payment_info', '') }}</textarea>

    <label for="repair_status">Stato riparazione</label>
    <select id="repair_status" name="repair_status">
        {% for value, label in repair_statuses %}
        <option value="{{ value }}" {% if request.form.get('repair_status', repair_statuses[0][0]) == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>

    <label for="date_received">Data ricezione</label>
    <input type="date" id="date_received" name="date_received" value="{{ request.form.get('date_received', '') }}">

    <label for="date_repaired">Data riparazione</label>
    <input type="date" id="date_repaired" name="date_repaired" value="{{ request.form.get('date_repaired', '') }}">

    <label for="date_returned">Data consegna</label>
    <input type="date" id="date_returned" name="date_returned" value="{{ request.form.get('date_returned', '') }}">

    <h3>Allegati</h3>
    <p class="info">Puoi allegare immagini o documenti utili al ticket (dimensione massima 16&nbsp;MB per invio).</p>
    <label for="attachments">Seleziona file</label>
    <input type="file" id="attachments" name="attachments" multiple>

    <button type="submit">Salva</button>
</form>
{% endblock %}
