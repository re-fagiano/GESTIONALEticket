{% extends 'base.html' %}
{% block title %}Magazzino{% endblock %}
{% block content %}
<style>
    .inventory-layout {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    .inventory-card {
        background: #fff;
        border: 1px solid #d9e1ff;
        border-radius: 6px;
        padding: 1rem 1.25rem;
        box-shadow: 0 1px 2px rgba(29, 40, 88, 0.08);
    }
    .inventory-card h3 {
        margin-top: 0;
        margin-bottom: 0.75rem;
    }
    .inventory-card form label {
        font-weight: 600;
        margin-top: 0.5rem;
    }
    .inventory-card form input,
    .inventory-card form textarea,
    .inventory-card form select {
        border: 1px solid #c3cde6;
        border-radius: 4px;
    }
    .inventory-card form textarea {
        min-height: 80px;
        resize: vertical;
    }
    .inventory-card .form-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
        margin-top: 1rem;
    }
    .inventory-card .button.secondary {
        background: #6c757d;
    }
    .inventory-search {
        margin-bottom: 1.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
    }
    .inventory-search input[type="text"] {
        flex: 1 1 220px;
        padding: 0.5rem;
        border-radius: 4px;
        border: 1px solid #c3cde6;
    }
    .inventory-search button {
        padding: 0.5rem 1rem;
    }
    .inventory-table tbody tr.low-stock {
        background: #fff4f4;
    }
    .badge-low-stock {
        background: #ffebee;
        color: #c62828;
    }
    .inventory-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: flex-end;
    }
    .inventory-summary {
        margin-bottom: 1.5rem;
        padding: 0.75rem 1rem;
        background: #fff;
        border: 1px solid #d9e1ff;
        border-radius: 6px;
    }
    @media (max-width: 720px) {
        .inventory-actions {
            justify-content: flex-start;
        }
    }
</style>
<h2>Magazzino</h2>
<p>Consulta e gestisci gli articoli presenti in magazzino. Utilizza il modulo per filtrare gli articoli oppure inseriscine di nuovi se necessario.</p>
<div class="inventory-summary">
    <strong>Articoli totali:</strong> {{ items|length }}
    &nbsp;|&nbsp;
    <strong>Quantità complessiva:</strong> {{ total_quantity }}
    {% if low_stock_ids %}
        &nbsp;|&nbsp;
        <strong>Articoli sotto scorta:</strong> {{ low_stock_ids|length }}
    {% endif %}
</div>
<form class="inventory-search" method="get" action="{{ url_for('magazzino') }}">
    <label for="magazzino-search">Ricerca</label>
    <input id="magazzino-search" type="text" name="q" placeholder="Cerca per codice, nome, posizione..." value="{{ search_query }}">
    <button type="submit">Filtra</button>
    {% if search_query %}
        <a class="button secondary" href="{{ url_for('magazzino') }}">Azzera</a>
    {% endif %}
</form>
{% set is_admin = current_user.is_admin if current_user.is_authenticated else False %}
{% if is_admin %}
<div class="inventory-layout">
    <div class="inventory-card">
        <h3>{% if edit_item %}Modifica articolo{% else %}Nuovo articolo{% endif %}</h3>
        <form method="post" action="{{ url_for('magazzino') }}">
            <input type="hidden" name="action" value="{% if edit_item %}update{% else %}create{% endif %}">
            <input type="hidden" name="q" value="{{ search_query }}">
            {% if edit_item %}
                <input type="hidden" name="item_id" value="{{ edit_item.id }}">
            {% endif %}
            <label for="code">Codice</label>
            <input id="code" type="text" name="code" required value="{{ edit_item.code if edit_item else '' }}">

            <label for="name">Nome</label>
            <input id="name" type="text" name="name" required value="{{ edit_item.name if edit_item else '' }}">

            <label for="quantity">Quantità</label>
            <input id="quantity" type="number" min="0" name="quantity" value="{{ edit_item.quantity if edit_item else 0 }}">

            <label for="minimum_quantity">Scorta minima</label>
            <input id="minimum_quantity" type="number" min="0" name="minimum_quantity" value="{{ edit_item.minimum_quantity if edit_item else 0 }}">

            <label for="location">Posizione</label>
            <input id="location" type="text" name="location" value="{{ edit_item.location if edit_item else '' }}">

            <label for="category">Categoria</label>
            <input id="category" type="text" name="category" value="{{ edit_item.category if edit_item else '' }}">

            <label for="description">Descrizione</label>
            <textarea id="description" name="description">{{ edit_item.description if edit_item else '' }}</textarea>

            <label for="notes">Note interne</label>
            <textarea id="notes" name="notes">{{ edit_item.notes if edit_item else '' }}</textarea>

            <div class="form-actions">
                <button type="submit">{% if edit_item %}Aggiorna articolo{% else %}Aggiungi articolo{% endif %}</button>
                {% if edit_item %}
                    <a class="button secondary" href="{{ url_for('magazzino', q=search_query or None) }}">Annulla</a>
                {% endif %}
            </div>
        </form>
    </div>
</div>
{% endif %}
<table class="inventory-table">
    <thead>
        <tr>
            <th>Codice</th>
            <th>Nome</th>
            <th>Quantità</th>
            <th>Scorta minima</th>
            <th>Posizione</th>
            <th>Categoria</th>
            <th>Descrizione</th>
            <th>Note</th>
            <th>Aggiornato il</th>
            {% if is_admin %}
                <th class="actions-column">Azioni</th>
            {% endif %}
        </tr>
    </thead>
    <tbody>
    {% if not items %}
        <tr>
            <td colspan="{% if is_admin %}10{% else %}9{% endif %}" style="text-align: center;">Nessun articolo trovato.</td>
        </tr>
    {% else %}
        {% for item in items %}
            <tr class="{% if item.id in low_stock_ids %}low-stock{% endif %}">
                <td>{{ item.code }}</td>
                <td>
                    {{ item.name }}
                    {% if item.id in low_stock_ids %}
                        <span class="badge badge-low-stock">Sotto scorta</span>
                    {% endif %}
                </td>
                <td>{{ item.quantity }}</td>
                <td>{{ item.minimum_quantity }}</td>
                <td>{{ item.location or '-' }}</td>
                <td>{{ item.category or '-' }}</td>
                <td>{{ item.description or '-' }}</td>
                <td>{{ item.notes or '-' }}</td>
                <td>{{ item.updated_at }}</td>
                {% if is_admin %}
                    <td class="actions-column">
                        <div class="inventory-actions">
                            <a class="button" href="{{ url_for('magazzino', q=search_query or None, edit=item.id) }}">Modifica</a>
                            <form method="post" action="{{ url_for('magazzino') }}" class="inline-form" onsubmit="return confirm('Eliminare definitivamente questo articolo?');">
                                <input type="hidden" name="action" value="delete">
                                <input type="hidden" name="item_id" value="{{ item.id }}">
                                <input type="hidden" name="q" value="{{ search_query }}">
                                <button type="submit" class="btn-danger">Elimina</button>
                            </form>
                        </div>
                    </td>
                {% endif %}
            </tr>
        {% endfor %}
    {% endif %}
    </tbody>
</table>
{% endblock %}
